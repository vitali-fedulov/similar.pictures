<!-- Copyright: Vitali Fedulov (fedulov.vitali@gmail.com) 2015-2023 -->
<!DOCTYPE html>
<html lang="en">
<head>



<script async src="//www.googletagmanager.com/gtag/js?id=G-2JHEHHKWBJ"></script>
<script>
 window.dataLayer = window.dataLayer || [];
 function gtag(){dataLayer.push(arguments);}
 gtag('js', new Date());

 gtag('config', 'G-2JHEHHKWBJ');
</script>


 <title>Similar image search on disk</title>
 <meta charset="utf-8">
 <meta name="viewport" content="width=device-width, initial-scale=1">
 <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto">
 <link rel="icon" type="image/png" href="images/favicon.png">
 <link rel="stylesheet" type="text/css" href="css/clustering.css">
</head>


<body>



 <div class="flex-container-select-files">
 <div class="flex-center-horizontally">
 <div>
 <h1 class="text-centered clustering-title">Similar Image Search</h1>
 </div>

 <div id="terms-of-service">
 <p class="terms-of-service-header text-centered">Terms of service and data protection</p>
 
 <div id="terms"></div>
 </div>

 <div>

 <p id="messages" class="hidden">Messages</p>

 <div id="ok-button" class="text-centered">
 <div class="button">OK</div>
 </div>

 
 <div id="image-selector" class="text-centered margin-bottom">
 <input type="file" accept="image/*"
 class="hidden" id="imageSelected"
 onchange="v4(this.files)">
 <a class="button" id="button-image-select">
 1. Select image to search
 </a>
 </div>

 
 <div id="folder-selector" class="text-centered">
 <input type="file" accept="image/*" webkitdirectory multiple
 class="hidden" id="filesSelected"
 onchange="v47(this.files)"
 onclick="v17()">
 <a class="button button-passive" id="button-folder-select">
 2. Where to search (select folder)
 </a>
 </div>

 <div class="fast-option">
 <input type="checkbox" id="fast-option" onclick="v7()">
 <div class="option-text">Option to accelerate the search (recommended). It has somewhat larger chance to mismatch pictures. The acceleration can be considerable for folders with many JPEG images.
 </div>
 </div>

 <div class="link-block text-centered">
 <a class="home-cancel-link" id="cancel-link" onclick="v46()">Cancel</a>
 <a class="home-cancel-link" href="/">Home</a>
 </div>

 </div>

 </div>
 
 </div>
 
 

 


 <div class="fixed-top hidden">

 <div class="fixed-top-gray">
 <a href = "index.html" class="logo-href"><span class="logo">Similar Image Search</a>
 <div class="button button-new-search">New search</div>
 </div>

 <div class="fixed-white-1">
 <div class="progress">
 <div id="progress-bar"></div>
 </div>
 <div class="progress-text"></div>
 </div>

 <div class="fixed-white-2 hidden">
 <span class="found-clusters"></span> <span> (</span><span class="view-list">show/hide as list</span><span>)</span>
 <textarea class="textarea"></textarea>
 <p class="explanation">
 <small class="small">Images are sorted by similarity from top down. Keep the browser tab open to avoid stopping the search.</small>
 </p>
 </div>

 </div>
 
 <div id="clusters" class="found-images"></div>
 


<script>

function load(url, element) {
 fetch(url)
 .then(response => response.text())
 .then(data => {
 element.innerHTML = data;
 })
 .catch(error => {
 console.error('Error:', error);
 });
}
window.addEventListener('DOMContentLoaded', () => {
 v6();
 load("tos_en.html", document.querySelector("#terms"));
 document.querySelector("#ok-button").style.display = 'none';
 document.querySelector("#cancel-link").style.display = 'none';
 document.querySelector(".button-new-search").addEventListener('click', (e) => {
 v52();
 });
 document.querySelector("#ok-button").addEventListener('click', (e) => {
 v52();
 });
 window.scrollTo({top: 0});
});


var v69 = {

 v82 : 24, v67 : 2,
 v37 : 12,
 v48 : 80000, v10 : 40*1024*1024, v61 : 0, v57 : 0,
 v16 : false,
 v11 : false,

 v87 : 0, v90 : [],

 v99 : [[], [], []],
 v127 : 0,
 v135 : 0,
 v38 : [],
 v95 : [[], [], []],
 v126 : 0,
 v124 : 0,

 v49 : 0,
 v31 : [],
 v117 : 10, v103 : 100, v36 : 50, v65 : 0.2, v55 : 2, v60 : 0.7,
 v28 : /(^image\/gif$)|(^image\/jpeg$)|(^image\/jpg$)|(^image\/bmp$)|(^image\/png$)|(^image\/webp$)/,
 v72 : "",

 v91 : null,
 v50 : 0,

 v27 : false,

 v1 : 1000,
 v0 : null,
 v14 : "image/jpeg", v9 : 0.6,
 v39 : 160, v33 : '\n',
 v20 : 0,
 v13 : false,
 v8 : 0,
};

var v71 = {
 v34 : v69.v37 * v69.v37,
 v111 : v69.v82 * v69.v37,
};


function v7() {
 localStorage.setItem("fast-option", document.querySelector("#fast-option").checked);
 return;
}

function v6() {
 if (localStorage.getItem("fast-option") == null) {
 document.querySelector("#fast-option").checked = true;
 return;
 }
 if (localStorage.getItem("fast-option") == 'false') {
 document.querySelector("#fast-option").checked = false;
 } else {
 document.querySelector("#fast-option").checked = true;
 }
 return;
}

function v46() {
 v52();
}


function v52() {
 location.reload();
}

document.getElementById('image-selector').addEventListener('click', v24);

function v24() {
 document.getElementById('imageSelected').click();
}

function v19() {
 document.getElementById('image-selector').removeEventListener('click', v24);
 document.getElementById('folder-selector').addEventListener('click', v18);
 document.getElementById("button-image-select").classList.add("button-passive");
 document.getElementById("button-folder-select").classList.remove("button-passive");
 document.getElementById("cancel-link").style.display = "block";
}

function v18() {
 var v94 = document.getElementById('filesSelected');
 if (!!v94.webkitdirectory == false) {
 alert('This browser does not support folder selection. Please try latest desktop Chrome, Firefox or Edge.');
 return;
 }
 v94.click();
}


function v25() {
 document.getElementById("messages").textContent = 'ERROR. The selected image cannot be read. Please select another image (or the same image in a different format).';
 document.getElementById("messages").style.display = "block";
 document.getElementById("cancel-link").style.display = "block";
}

function v5() {
 document.getElementById("terms-of-service").style.display = "block";
 document.getElementById("messages").style.display = "none";
 document.getElementById("cancel-link").style.display = "none";
}


function v40(v84, v100, v115, v68) {
 v84.readAsArrayBuffer(v115.slice(0, v69.v48));
 v84.onload = function (v98) {
 var v96 = new Uint8Array(v98.target.result),
 v93, v116;
 var v145 = 0;
 for (var v145 = 2; v145 < v96.length; v145++) {
 if (v96[v145] == 0xFF) {
 if (!v93) {
 if (v96[v145 + 1] == 0xD8) {
 v93 = v145;
 }
 } else {
 if (v96[v145 + 1] == 0xD9) {
 v116 = v145 + 2; break;
 }
 }
 }
 }
 if (v93 && v116) {
 v68(new Blob([v96.subarray(v93, v116)], {type:"image/jpeg"}));
 } else {
 v68(null);
 }
 };

 v84.onerror = function() {
 v68(null);
 };
}


function v23(v83) {
 if (v69.v20 < 2) {

 document.querySelector(".fixed-top").style.display = "none";
 document.querySelector(".flex-container-select-files").style.display = "block";
 document.getElementById("messages").textContent = "The selected folder has less than 2 images of supported types. There is nothing to compare. Please select a different folder.";
 document.getElementById("messages").style.display = "block";
 document.getElementById("folder-selector").style.display = "none";
 document.getElementById("cancel-link").style.display = "none";
 document.getElementById("ok-button").style.display = "block";
 return;
 }
 var progressElement = document.querySelector(".progress");
 if (progressElement) progressElement.parentNode.removeChild(progressElement);
 var v144 = "s";
 if (v83 + 1 == 1) {
 v144 = "";
 }
 v12(".progress-text", "Successfully scanned ".concat(v69.v91.length, " file", v144, "."));
 if (v69.v49 == 0) {
 v12(".progress-text", "Zero similar images found from the successfully scanned ".concat(v69.v91.length, " file", v144, "."));
 }
 return;
}


function v63() {

 var v143 = 0, v140 = 0, v130 = 0, v129 = 0;

 var v62 = 0;
 for (v143 = 1; v143 < v69.v82 - 1; v143+= v69.v67) {
 for (v140 = 1; v140 < v69.v82 - 1; v140+= v69.v67) {
 var v15 = [];
 for (v130 = -1; v130 < 2; v130++) {
 for (v129 = -1; v129 < 2; v129++) {
 v15.push((v140 + v129) * v69.v82 + v143 + v130);
 }}
 v69.v90[v62] = v15;
 v62++;
 }}
 v69.v76 = v15.length;
 v69.v87 = v62;
 v69.v64 = 1 / v62;

 v71.v66 = v69.v87 * v69.v36 * v69.v36 * v69.v65;
 v71.v53 = v71.v66 * v69.v55;

 return;
}

v63();

function v74(v83) {

 var v133 = 0, v131 = 0, v128 = 0, v125 = 0, v80 = 0, v113 = 0, v73 = 0;

 v133 = v69.v127, v134 = v69.v135;
 v131 = v69.v126, v123 = v69.v124;
 if (v133 * v123 * v69.v103 + v69.v117 * v133 * v131 < v131 * v134* v69.v103 ||
 v133 * v123 * v69.v103 > v131 * v134 * v69.v103 + v69.v117 * v133 * v131) {
 return false;
 }

 v80 = 0;
 for (v73 = 0; v73 < v69.v87; v73++) {
 v128 = v69.v99[0][v73];
 v125 = v69.v95[0][v73];
 v80 += (v128 - v125) * (v128 - v125);
 }
 if (v80 > v71.v66) {
 return false;
 }

 v113 = 0;
 for (v73 = 0; v73 < v69.v87; v73++) {
 v128 = v69.v99[1][v73];
 v125 = v69.v95[1][v73];
 v113 += (v128 - v125) * (v128 - v125);
 }
 if (v113 > v71.v53) {
 return false;
 }

 v113 = 0;
 for (v73 = 0; v73 < v69.v87; v73++) {
 v128 = v69.v99[2][v73];
 v125 = v69.v95[2][v73];
 v113 += (v128 - v125) * (v128 - v125);
 }
 if (v113 > v71.v53) {
 return false;
 }

 v69.v31.push({v110:v80, v83:v83});

 return true;
}

function v12(v92, v106) {
 var element = document.querySelector(v92);
 if (element) element.textContent = v106;
}

function v2() {
 var v144 = "s";
 if (v69.v49 == 1) {
 v144 = "";
 }
 v12(".found-clusters", "Found ".concat(v69.v49, ' similar image', v144));
}

function v3(v83) {
 if (v83 + 1 == v69.v50) {
 return;
 }
 v12(".progress-text", "Please wait... Comparing to ".concat(v83, ' from ', v69.v50, ' selected files.'));
 var v79 = Math.floor(100 * (v83 + 1) / v69.v50);
 if (v79 < 5) {
 v79 = 5;
 }
 var v70 = "".concat(v79, "%");
 var v42 = document.getElementById("progress-bar");
 if (v42) v42.style.width = v70;

}
function v75(v45, v35) {
 var v107 = document.createElement("div");
 v107.className = v45;
 v35.appendChild(v107);
 return v107;
}

var v44 = document.getElementById("clusters");
function v21(v83) {

 var v121 = v56(v83);
 v121.id = v83;
 v44.appendChild(v121);

 v69.v31.sort(function(v149, v147) {
 if (v149.v110 > v147.v110) {
 return 1;
 }
 if (v149.v110 < v147.v110) {
 return -1;
 }
 return 0;
 });
 
 var v145 = 0;
 for (v145 = 0; v145 < v69.v31.length; v145++) {
 document.getElementById(v69.v31[v145].v83).style.order = v145;
 }
}

function v56(v83) {
 var v119 = new Image();
 var v121 = document.createElement("div");
 v121.className = "cluster";
 v121.id = v83;
 var v26 = v75("cluster-content", v121);
 var v78 = v75("cluster-imgs", v26);
 var v85 = v75("cluster-img-div", v78);
 v119.width = v69.v39;
 v85.appendChild(v119);
 v119.classList.add("cluster-img");
 var v59 = v75("image-size", v85);
 v59.textContent = "".concat(v69.v126, "×", v69.v124);
 var v22 = v75("cluster-paths", v26);
 var v54 = v75("img-path", v22);
 v54.textContent = v69.v91[v83].webkitRelativePath;
 v29(v83, v119, v59);
 return v121;
}


function v29(v83, v119, v59) {
 var v84 = new FileReader(); v84.onload = function() {
 return function(e) {
 var v41 = new Image();
 v41.src = e.target.result;
 var v88 = document.createElement("canvas");
 var v120 = v88.getContext("2d", { willReadFrequently: true });
 v41.onload = function() {
 v59.textContent = "".concat(v41.width, "×", v41.height);
 if (v41.width >= v41.height) {
 v88.height = v69.v39 * 2; v88.width = ~~(v41.width * v88.height / v41.height);
 } else {
 v88.width = v69.v39 * 2;
 v88.height = ~~(v41.height * v88.width / v41.width);
 }
 v119.width = v88.width / 2; v119.height = v88.height / 2;
 v120.drawImage(v41, 0, 0, v88.width, v88.height);
 v119.src = v88.toDataURL(v69.v14, v69.v9);
 v88 = null; v120 = null;
 v41 = null;
 v84 = null;
 v69.v8++;
 };
 };
 } ();
 v84.readAsDataURL(v69.v91[v83]);
}


function v58() {
 var v104 = "";
 var v145 = 0;
 for (v145 = 0; v145 < v69.v31.length; v145++) {
 v104 = v104.concat(v69.v91[v69.v31[v145].v83].webkitRelativePath, v69.v33);
 }
 v104 = v104.slice(0, -1); document.querySelector(".textarea").value = v104;
 document.querySelector(".textarea").classList.toggle("textareaon");
}

function v17() {
 document.querySelector("#terms-of-service").style.display = 'none';
 v69.v0 = setTimeout(function() {
 document.querySelector("#messages").textContent = 'Please wait if you selected a very large number of images: it may take tens of seconds before the clustering starts.';
 document.querySelector("#messages").style.display = 'block';
 document.querySelector("#image-selector").style.display = 'none';
 document.querySelector("#folder-selector").style.display = 'none';
 document.querySelector(".fast-option").style.display = 'none';
 document.querySelector("#cancel-link").style.display = 'block';
 }, v69.v1);
}


function v105(v77, v145, v148, v114) {
 return [v77[v148 * (v114 * 4) + (v145 * 4)],
 v77[v148 * (v114 * 4) + (v145 * 4) + 1],
 v77[v148 * (v114 * 4) + (v145 * 4) + 2]];
 }
function v43(v77) {

 var v102 = [[], [], []];
 var v145 = 0, v148 = 0, v139 = 0, v141 = 0;
 var v136 = 0, v142 = 0, v147 = 0;
 var v97 = 0, v101 = 0, v89 = 0; var v144 = 0;
 var v81 = [];
 var v132 = 0, v138 = 0, v146 = 0;

 for (v132 = 0; v132 < v69.v87; v132++) {
 v97 = 0, v101 = 0, v89 = 0;
 v144 = 0;
 for (v138 = 0; v138 < v69.v76; v138++ ) {
 v145 = ~~(v69.v90[v132][v138] / v69.v82);
 v148 = v69.v90[v132][v138] % v69.v82;
 for (v146 = 0; v146 < v71.v34; v146++) {
 v139 = ~~(v146 / v69.v37);
 v141 = v146 % v69.v37;
 v81 = v105(v77, v145 * v69.v37 + v139,
 v148 * v69.v37 + v141, v71.v111);
 v136 = v81[0];
 v142 = v81[1];
 v147 = v81[2];

 v97 += 0.299000 * v136 + 0.587000 * v142 + 0.114000 * v147;
 v101 += 128 - 0.168736 * v136 - 0.331264 * v142 + 0.500000 * v147;
 v89 += 128 + 0.500000 * v136 - 0.418688 * v142 - 0.081312 * v147;
 v144++;

 }
 
 }
 v102[0][v132] = v97 / v144; v102[1][v132] = v101 / v144;
 v102[2][v132] = v89 / v144;
 }

 return [v51(v102[0]), v51(v102[1]), v51(v102[2])];
}


function v51(v122) {
 var v86 = [];
 var v137 = v122.length;
 var v108 = 0; var v112 = Number.POSITIVE_INFINITY;
 var v141 = 0;
 for (v141 = 0; v141 < v137; v141++) {
 if (v122[v141] > v108) {
 v108 = v122[v141];
 } else if (v122[v141] < v112) {
 v112 = v122[v141];
 }
 }
 var v118 = v108 - v112;
 for (v141 = 0; v141 < v137; v141++) {
 v86[v141] = (v122[v141] - v112) * 255 / v118;
 }
 return v86;
}


function v4(v91) {

const v32 = v91[0];
var v84 = new FileReader();
var v119 = new Image();
var v88 = document.createElement("canvas");
v88.width = v71.v111;
v88.height = v71.v111;
var v120 = v88.getContext("2d", { willReadFrequently: true });
v5();

v84.onerror = function() {
 v25();
 return;
};
v84.onload = function() {
 return function(e) {
 v119.src = e.target.result;
 
 v119.onerror = function() {
 v25();
 return;
 };
 
 v119.onload = function() {
 return function(e2) {
 v120.drawImage(v119, 0, 0, v71.v111, v71.v111);
 v69.v99 = v43(v120.getImageData(0, 0, v71.v111, v71.v111).data);

 v69.v127 = v119.width;
 v69.v135 = v119.height;

 v19();
 };
 } ();
 };
} ();
v84.readAsDataURL(v91[0]);
}


function v47(v91) {
 v69.v16 = document.querySelector("#fast-option").checked;
 v69.v8 = 0;
 clearTimeout(v69.v0);
 document.querySelector("#folder-selector").style.display = 'none';
 v69.v91 = v91;
 v69.v72 = v91[0].webkitRelativePath.split("/")[0];
 v69.v50 = v91.length;
 var v83 = 0; var v100 = 0;
 var v84 = new FileReader();
 var v119 = new Image();
 var v88 = document.createElement("canvas");
 v88.width = v71.v111;
 v88.height = v71.v111;
 var v120 = v88.getContext("2d", { willReadFrequently: true });
 document.querySelector(".flex-container-select-files").style.display = 'none';
 document.querySelector(".fixed-top").style.display = 'block';
 document.querySelector(".view-list").addEventListener('click', (e) => {
 v58();
 });
 document.querySelector(".fixed-white-2").style.display = 'block';
 v2();
 v30(v83, v100, v84, v119, v120);
}
function v30(v83, v100, v84, v119, v120) {
 
 if (v83 >= v69.v50) {
 v23(v83);
 return;
 }
 
 if (!v69.v28.test(v69.v91[v83].type) || v69.v91[v83].size > v69.v10) {
 v83++;
 v30(v83, v100, v84, v119, v120);
 return;
 }



 if (v69.v16 &&
 v69.v91[v83].type == "image/jpeg" &&
 !v69.v27) {

 v40(v84, v100, v69.v91[v83], function(v109) {
 
 if (v109 == null) {
 v69.v27 = true;
 v30(v83, v100, v84, v119, v120);
 return;

 } else {

 v119.src = URL.createObjectURL(v109);

 v119.onload = function() {
 
 v69.v20++;
 if (v83 < 5 || v83 % 5 === 0) {
 v3(v83);
 }
 v120.drawImage(v119, 0, 0, v71.v111, v71.v111);


 v69.v95 = v43(v120.getImageData(0, 0, v71.v111, v71.v111).data);
 v69.v126 = v119.width;
 v69.v124 = v119.height;

 v69.v61 = v100 + 1;
 v69.v57 = v83 + 1;

 if (v74(v83)) {
 v69.v49++;
 v21(v83);
 v2();
 }

 v83++;
 v100++;

 if (!v69.v13) {
 v69.v13 = true;
 }
 v69.v27 = false;
 URL.revokeObjectURL(v119.src); v30(v83, v100, v84, v119, v120);
 return;
 };

 v119.onerror = function() {
 URL.revokeObjectURL(v119.src); v69.v27 = true;
 v30(v83, v100, v84, v119, v120);
 return;
 };

 return;
 }
 });

 } else {
 v69.v27 = true;
 }

 if (v69.v27 == false) {
 return;
 }



 v84.readAsDataURL(v69.v91[v83]);
 
 v84.onerror = function() {
 v83++;
 v69.v27 = false;
 v30(v83, v100, v84, v119, v120);
 return;
 };

 v84.onload = function(evt) {
 v119.src = evt.target.result;
 
 v119.onerror = function() {
 v83++;
 v69.v27 = false;
 v30(v83, v100, v84, v119, v120);
 return;
 };
 
 v119.onload = function() {
 v69.v20++;
 if (v83 < 5 || v83 % 5 === 0) {
 v3(v83);
 }
 v120.drawImage(v119, 0, 0, v71.v111, v71.v111);

 v69.v95 = v43(v120.getImageData(0, 0, v71.v111, v71.v111).data);
 v69.v126 = v119.width;
 v69.v124 = v119.height;

 v69.v61 = v100 + 1;
 v69.v57 = v83 + 1;

 if (v74(v83)) {
 v69.v49++;
 v21(v83);
 v2();

 }

 v83++;
 v100++;
 
 if (!v69.v13) {
 v69.v13 = true;
 }
 v69.v27 = false;
 URL.revokeObjectURL(v119.src);
 v30(v83, v100, v84, v119, v120);
 return;
 };
 };
}


</script> 
</body>
</html>